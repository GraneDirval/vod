services:
    PiwikBundle\Service\NewTracker:
        factory: ['@PiwikBundle\Service\PiwikClientFactory', getPiwikClient]
        arguments:
            - 1
            - '@PiwikBundle\Service\PiwikDataMapper'

    PiwikBundle\Twig\PiwikExtension:
        arguments: ['@PiwikBundle\Api\JsClient', '%piwik_enable_js_tracker%']
        tags:
            - { name: twig.extension }

    PiwikBundle\Api\ClientAbstract:
        abstract: true
        arguments: ['%piwik_id_site%', '%piwik_host%', '%piwik_https%', '%piwik_token_auth%']
        calls:
            - [setRabbitMQProducer, ['@PiwikBundle\Service\RabbitMQProducer']]

    PiwikBundle\Api\PhpClient:
        parent: PiwikBundle\Api\ClientAbstract
        arguments: ['@logger']

    PiwikBundle\Api\JsClient:
        parent: PiwikBundle\Api\ClientAbstract
        calls:
            - ['setEnableLinkTracking', ['%piwik_enable_link_tracking%']]

    PiwikBundle\Service\PiwikDataSender:
        arguments:
            - '@PiwikBundle\Service\PiwikClientFactory'

    PiwikBundle\Service\RabbitMQProducer:
        arguments: ['%rabbit_mq_host%', '%rabbit_mq_port%', '%rabbit_mq_user%', '%rabbit_mq_password%', '%rabbit_mq_vhost%']

    PiwikBundle\Service\PiwikClientFactory:
        arguments:
            - '%piwik_enable_js_tracker%'
            - '@PiwikBundle\Api\PhpClient'
            - '@PiwikBundle\Api\JsClient'

    PiwikBundle\Service\PiwikDataMapper: ~