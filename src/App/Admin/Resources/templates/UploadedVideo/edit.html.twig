{% extends '@SonataAdmin/CRUD/edit.html.twig' %}
{% block form %}
    {{ parent() }}
    <script>
        function FormControl(form, adminUniqueId) {
            this.form = form;
            this.action = form.attr('action');
            this.method = form.attr('method');
            this.adminUniqueId = adminUniqueId;

            this.getFieldIdentifier = function(fieldName) {
                return `#${this.adminUniqueId}_${fieldName}`;
            };

            this.sendAjaxrequest = function(data) {
                return $.ajax({
                    url: this.action,
                    type: this.method,
                    data: data
                })
            };

            this.handleCategoryField = function(html) {
                $(this.getFieldIdentifier('mainCategory')).closest('.form-group').after(
                    $(html).find(this.getFieldIdentifier('category')).closest('.form-group')
                );
            }.bind(this);
        }

        $(document).ready(function () {
            var adminUniqueId = "{{ admin.uniqId }}";
            var mainCategoryField = $(`#${adminUniqueId}_mainCategory`);
            var formControl = new FormControl($(mainCategoryField).closest('form'), adminUniqueId);

            mainCategoryField.change(function() {
                var data = {};
                data[mainCategoryField.attr('name')] = mainCategoryField.val();

                formControl
                    .sendAjaxrequest(data)
                    .done(formControl.handleCategoryField)
            })
        })
    </script>
{% endblock %}